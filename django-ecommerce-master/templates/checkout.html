{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<main>
  <div class="container wow fadeIn">
    <h2 class="my-5 h2 text-center">Checkout form</h2>
    <div class="row">
      <div class="col-md-8  col-sm-6 col-lg-12 mb-4 mr-4">
        <div class="card">
          <form id="form" method="POST" class="card-body">
            {% csrf_token %}
              <ul class="stepper horizontal horizontal-fix" id="custom-validation">
                <li class="step active">
                  <div class="step-title waves-effect waves-dark">
                    <small>payment option</small></div>
                  <div class="step-new-content">
                    <div class="row">
                      <div class="md-form col-12 ml-auto">
                        <div class="d-block my-3">
                          {% for value, name in form.fields.payment_option.choices %}
                          <div class="custom-control custom-radio">
                            <input id="{{ name }}" name="payment_option" value="{{ value }}" type="radio" class="validate custom-control-input" required>
                            <label class="custom-control-label" for="{{ name }}">{{ name }}</label>
                          </div>
                          {{name}}
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                    <div class="step-actions">
                      <button class="waves-effect waves-dark btn btn-sm btn-primary next-step"
                        data-feedback="validationFunction">next</button>
                    </div>
                  </div>
                </li>
                <li class="step">
                  <div class="step-title waves-effect waves-dark"><small>shipping address</small></div>
                  <div class="step-new-content">
                    <div class="row">
                      <div class="md-form col-12 ml-auto">
                      <div class='hideable_shipping_form'>
                      
                        <div class="md-form mb-5">
                          <input type='text' placeholder='1234 Main St' id='shipping_address' name='shipping_address' class='form-control' />
                          <label for="shipping_address" class="">Address</label>
                        </div>
                      
                        <div class="md-form mb-5">
                          <input type='text' placeholder='Apartment or suite' id='shipping_address2' name='shipping_address2'
                            class='form-control' />
                          <label for="shipping_address2" class="">Address 2 (optional)</label>
                        </div>
                      
                        <div class="row">
                          <div class="col-lg-4 col-md-12 mb-4">
                            <label for="country">Country</label>
                            {{ form.shipping_country }}
                            <div class="invalid-feedback">
                              Please select a valid country.
                            </div>
                          </div>
                          <div class="col-lg-4 col-md-6 mb-4">
                            <label for="shipping_zip">Zip</label>
                            <input type='text' placeholder='Zip code' id='shipping_zip' name='shipping_zip' class='form-control' />
                            <div class="invalid-feedback">
                              Zip code required.
                            </div>
                          </div>
                        </div>
                      
                        <div class="custom-control custom-checkbox">
                          <input type="checkbox" class="custom-control-input" name="same_billing_address" id="same_billing_address">
                          <label class="custom-control-label" for="same_billing_address">Billing address is the same as my shipping
                            address</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                          <input type="checkbox" class="custom-control-input" name="set_default_shipping" id="set_default_shipping">
                          <label class="custom-control-label" for="set_default_shipping">Save as default shipping address</label>
                        </div>
                      
                      </div>
                      
                      {% if default_shipping_address %}
                      <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" name="use_default_shipping" id="use_default_shipping">
                        <label class="custom-control-label" for="use_default_shipping">Use default shipping address:
                          {{ default_shipping_address.street_address|truncatechars:10 }}</label>
                      </div>
                      {% endif %}

                      </div>
                    </div>
                    <div class="step-actions">
                      <button class="waves-effect waves-dark btn btn-sm btn-primary next-step"
                        data-feedback="validationFunction">next</button>
                      <button class="waves-effect waves-dark btn btn-sm btn-secondary previous-step">back</button>
                    </div>
                  </div>
                </li>
                <li class="step">
                  <div class="step-title waves-effect waves-dark"><small>billing address</small></div>
                  <div class="step-new-content">
                    <div class="row">
                      <div class="md-form col-12 ml-auto">
                        <div class='hideable_billing_form'>
                          <div class="md-form mb-5">
                            <input type='text' placeholder='1234 Main St' id='billing_address' name='billing_address' class='form-control' />
                            <label for="billing_address" class="">Address</label>
                          </div>
                        
                          <div class="md-form mb-5">
                            <input type='text' placeholder='Apartment or suite' id='billing_address2' name='billing_address2'
                              class='form-control' />
                            <label for="billing_address2" class="">Address 2 (optional)</label>
                          </div>
                        
                          <div class="row">
                            <div class="col-lg-4 col-md-12 mb-4">
                              <label for="country">Country</label>
                              {{ form.billing_country }}
                              <div class="invalid-feedback">
                                Please select a valid country.
                              </div>
                            </div>
                        
                            <div class="col-lg-4 col-md-6 mb-4">
                              <label for="billing_zip">Zip</label>
                              <input type='text' placeholder='Zip code' id='billing_zip' name='billing_zip' class='form-control' />
                              <div class="invalid-feedback">
                                Zip code required.
                              </div>
                            </div>
                        
                          </div>
                        
                          <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" name="set_default_billing" id="set_default_billing">
                            <label class="custom-control-label" for="set_default_billing">Save as default billing address</label>
                          </div>
                        
                        </div>
                        
                        {% if default_billing_address %}
                        <div class="custom-control custom-checkbox">
                          <input type="checkbox" class="custom-control-input" name="use_default_billing" id="use_default_billing">
                          <label class="custom-control-label" for="use_default_billing">Use default billing address:
                            {{ default_billing_address.street_address|truncatechars:10 }}</label>
                        </div>
                        {% endif %}
                        <hr>
                
                      </div>
                    </div>
                    <div class="step-actions">
                      <button class="waves-effect waves-dark btn btn-sm btn-primary next-step"
                        data-feedback="validationFunction">next</button>
                      <button class="waves-effect waves-dark btn btn-sm btn-secondary previous-step">back</button>
                    </div>
                  </div>
                </li>
                <li class="step">
                 
                  <div class="step-title waves-effect waves-dark"><small>submit</small></div>
                  <div class="step-new-content">
                    Finish! &nbsp; Continue to checkout
                    <div class="step-actions">
                      <button class="waves-effect waves-dark btn btn-sm btn-primary m-0 mt-4" type="submit">SUBMIT</button>
                    </div>
                  </div>
                </li>
              </ul>
          </form>
        </div>
          
      </div>
          
          <div class="col-md-4 mb-4">
            {% include "order_snippet.html" %}
          </div>
          
    </div>
          
  </div>
</main>
 

{% endblock content %}

{% block extra_scripts %}
<script>
   function validationFunction() {
      setTimeout(function () {
        $('#custom-validation').nextStep();
      }, 100);
    }
    function someTrueFunction() {
      return true;
    }

    $(document).ready(function () {
      $('.stepper').mdbStepper();
    })


  $('#form').on('submit', function (e) {

    e.preventDefault();

    $.ajax({
      type: "POST",
      url: "{% url 'core:checkout' %}", /* django ajax posting url  */
      data: {
  
        payment_option:$('#{{name}}').val(),
        shipping_address:$('#shipping_address').val(),
        shipping_address2: $('#shipping_address2').val(),
        shipping_country:$('#id_shipping_country').val(),
        shipping_zip: $('#shipping_zip').val(),
        same_billing_address: $('#same_billing_address').val(),
        set_default_shipping: $('#set_default_shipping').val(),
        use_default_shipping: $('#use_default_shipping').val(),

       
        billing_address: $('#billing_address').val(),
        billing_address2: $('#billing_address2').val(),
        billing_country: $('#id_billing_country').val(),
        billing_zip: $('#billing_zip').val(),
        set_default_billing: $('#set_default_billing').val(),
        use_default_billing: $('#use_default_billing').val(),


        csrfmiddlewaretoken: '{{ csrf_token }}',
        dataType: "json",

      },

      success: function (data) {
       toastr.data.message.tags ('{{ message }}')
      },

      failure: function () {

      }


    });


  });     





var hideable_shipping_form = $('.hideable_shipping_form');
var hideable_billing_form = $('.hideable_billing_form');

var use_default_shipping = document.querySelector("input[name=use_default_shipping]");
var use_default_billing = document.querySelector("input[name=use_default_billing]");

use_default_shipping.addEventListener('change', function() {
  if (this.checked) {
    hideable_shipping_form.hide();
  } else {
    hideable_shipping_form.show();
  }
})



use_default_billing.addEventListener('change', function() {
  if (this.checked) {
    hideable_billing_form.hide();
  } else {
    hideable_billing_form.show();
  }
})

</script>
{% endblock extra_scripts %}
